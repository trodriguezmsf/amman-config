<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet id="AMMAN_CONFIG_20230900774338862" author="Venky, Shyam">
    <comment>Adding Concepts for Lower Limb Physiotherapy Assessment Form</comment>
    <sqlFile path="concepts/lowerLimbPhysiotherapyAssessment_2.sql"/>
  </changeSet>

  <changeSet id="AMMAN_CONFIG_20230900774338863" author="Venky, Shyam">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">
                select count(*) from concept_answer ca
                join
                concept_name cn
                on ca.concept_id = cn.concept_id
                where ca.answer_concept IN (select concept_id from concept_name where name IN
                ("Bone lengthening", "Bone transportation", "Post-fracture rehabilitation", "Elongation of Achelous tendon-ETA", "Post-burn contracture management", "Peripheral nerve injury rehabilitation", "Post-quadricepsplasty", "Total hip replacement rehabilitation", "Tendon rehabilitation", "Amputation", "Other")
                and concept_name_type = "FULLY_SPECIFIED")
                AND
                cn.concept_id IN (select concept_id from concept_name where name = "LLA, Reason for physiotherapy referral");
      </sqlCheck>
    </preConditions>
    <comment>Adding Answers to LLA, Reason for physiotherapy referral</comment>
    <sql>
            select concept_id into @concept_id from concept_name where name = "LLA, Reason for physiotherapy referral" and
            concept_name_type = "FULLY_SPECIFIED" and locale = "en" and voided = 0;
            set @child1_concept_id = 0;
            set @child2_concept_id = 0;
            set @child3_concept_id = 0;
            set @child4_concept_id = 0;
            set @child5_concept_id = 0;
            set @child6_concept_id = 0;
            set @child7_concept_id = 0;
            set @child8_concept_id = 0;
            set @child9_concept_id = 0;
            set @child10_concept_id = 0;
            set @child11_concept_id = 0;
            
            select concept_id into @child1_concept_id from concept_name where name ="Bone lengthening" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child2_concept_id from concept_name where name ="Bone transportation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child3_concept_id from concept_name where name ="Post-fracture rehabilitation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child4_concept_id from concept_name where name ="Elongation of Achelous tendon-ETA" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child5_concept_id from concept_name where name ="Post-burn contracture management" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child6_concept_id from concept_name where name ="Peripheral nerve injury rehabilitation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child7_concept_id from concept_name where name ="Post-quadricepsplasty" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child8_concept_id from concept_name where name ="Total hip replacement rehabilitation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child9_concept_id from concept_name where name ="Tendon rehabilitation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child10_concept_id from concept_name where name ="Amputation" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            select concept_id into @child11_concept_id from concept_name where name ="Other" and concept_name_type ="FULLY_SPECIFIED" and locale ="en" and voided = 0;
            
            call add_concept_answer(@concept_id, @child1_concept_id, 1);
            call add_concept_answer(@concept_id, @child2_concept_id, 2);
            call add_concept_answer(@concept_id, @child3_concept_id, 3);
            call add_concept_answer(@concept_id, @child4_concept_id, 4);
            call add_concept_answer(@concept_id, @child5_concept_id, 5);
            call add_concept_answer(@concept_id, @child6_concept_id, 6);
            call add_concept_answer(@concept_id, @child7_concept_id, 7);
            call add_concept_answer(@concept_id, @child8_concept_id, 8);
            call add_concept_answer(@concept_id, @child9_concept_id, 9);
            call add_concept_answer(@concept_id, @child10_concept_id, 10);
            call add_concept_answer(@concept_id, @child11_concept_id, 11);
    </sql>
  </changeSet>

  <changeSet id="AMMAN_CONFIG_20230900774338864" author="Venky, Shyam">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">
                select COUNT(*) from concept_set cs
                join concept_name cn
                on cs.concept_id = cn.concept_id
                where cs.concept_id IN (select concept_id from concept_name where name IN
                ("LLA, Reason for physiotherapy referral", "LLA, Other reason for physiotherapy referral") AND concept_name_type = "FULLY_SPECIFIED")
                and cs.concept_set IN (select concept_id from concept_name where name = 'Lower Limb Physiotherapy Assessment');
      </sqlCheck>
    </preConditions>
    <comment>Adding set members for "Lower Limb Physiotherapy Assessment" Concept</comment>
    <sql>
            set @concept_id = 0;
            set @member1_concept_id = 0;
            set @member2_concept_id = 0;

            select concept_id into @concept_id from concept_name where name = "Lower Limb Physiotherapy Assessment" and concept_name_type = 'FULLY_SPECIFIED' and locale = 'en' and voided = 0;
            select concept_id into @member1_concept_id from concept_name where name = "LLA, Reason for physiotherapy referral" and concept_name_type = 'FULLY_SPECIFIED' and locale = 'en' and voided = 0;
            select concept_id into @member2_concept_id from concept_name where name = "LLA, Other reason for physiotherapy referral" and concept_name_type = 'FULLY_SPECIFIED' and locale = 'en' and voided = 0;
            
            call add_concept_set_members (@concept_id, @member1_concept_id, 26);
            call add_concept_set_members (@concept_id, @member2_concept_id, 27);
    </sql>
  </changeSet>

  <changeSet id="AMMAN_CONFIG_20230900774338865" author="Venky, Shyam">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="54">
                select COUNT(*) from concept_set cs
                join concept_name cn
                on cs.concept_id = cn.concept_id
                where cs.concept_id IN (select concept_id from concept_name where name IN
                ("LLA, Date recorded", "LLA, Type of assessment", "LLA, Previous history of physiotherapy", "LLA, Details of previous physiotherapy", "LLA, Chief complaint of patient", "LLA, Problem List", "LLA, Affected side", "LLA, Reason for physiotherapy referral", "LLA, Other reason for physiotherapy referral", "LLA, Independence of Patient", "LLA, Does the patient use an assistive device or orthosis?", "LLA, Type of assistive device or orthosis", "LLA, Other type of assistive device", "LLA, Comments about assistive device or orthosis", "LLA, Amputee patient?", "LLA, Level of amputation", "LLA, Leg Length Discrepancy (LLD)", "LLA, Pain Assessment", "LLA, R.O.M Test for Lower Limbs", "LLA, Muscle Test for Lower Limbs", "LLA, Neurological exam of lower limb", "LLA, Tinetti Balance Assessment Tool", "LLA, How old is the patient", "LLA, Pediatric Lower Extremity Function(Mobility)", "LLA, Lower Extremity Functional Index (LEFI)", "LLA, Additional comments", "LLA, Follow-up Plan") AND concept_name_type = "FULLY_SPECIFIED")
                and cs.concept_set IN (select concept_id from concept_name where name = 'Lower Limb Physiotherapy Assessment');
      </sqlCheck>
    </preConditions>
    <comment>Reorder sections in Upper Limb Physiotherapy Assessment</comment>
    <sql>
            set @observation_form_name = "Lower Limb Physiotherapy Assessment";
            # Reorder concepts (Concept set full name, Concept full name, sort weight)
            call reorder_concept_set(@observation_form_name, "LLA, Date recorded", 1);
            call reorder_concept_set(@observation_form_name, "LLA, Type of assessment", 2);
            call reorder_concept_set(@observation_form_name, "LLA, Previous history of physiotherapy", 3);
            call reorder_concept_set(@observation_form_name, "LLA, Details of previous physiotherapy", 4);
            call reorder_concept_set(@observation_form_name, "LLA, Chief complaint of patient", 5);
            call reorder_concept_set(@observation_form_name, "LLA, Problem List", 6);
            call reorder_concept_set(@observation_form_name, "LLA, Affected side", 7);
            call reorder_concept_set(@observation_form_name, "LLA, Reason for physiotherapy referral", 8);
            call reorder_concept_set(@observation_form_name, "LLA, Other reason for physiotherapy referral", 9);
            call reorder_concept_set(@observation_form_name, "LLA, Independence of Patient", 10);
            call reorder_concept_set(@observation_form_name, "LLA, Does the patient use an assistive device or orthosis?", 11);
            call reorder_concept_set(@observation_form_name, "LLA, Type of assistive device or orthosis", 12);
            call reorder_concept_set(@observation_form_name, "LLA, Other type of assistive device", 13);
            call reorder_concept_set(@observation_form_name, "LLA, Comments about assistive device or orthosis", 14);
            call reorder_concept_set(@observation_form_name, "LLA, Amputee patient?", 15);
            call reorder_concept_set(@observation_form_name, "LLA, Level of amputation", 16);
            call reorder_concept_set(@observation_form_name, "LLA, Leg Length Discrepancy (LLD)", 17);
            call reorder_concept_set(@observation_form_name, "LLA, Pain Assessment", 18);
            call reorder_concept_set(@observation_form_name, "LLA, R.O.M Test for Lower Limbs", 19);
            call reorder_concept_set(@observation_form_name, "LLA, Muscle Test for Lower Limbs", 20);
            call reorder_concept_set(@observation_form_name, "LLA, Neurological exam of lower limb", 21);
            call reorder_concept_set(@observation_form_name, "LLA, Tinetti Balance Assessment Tool", 22);
            call reorder_concept_set(@observation_form_name, "LLA, How old is the patient", 23);
            call reorder_concept_set(@observation_form_name, "LLA, Pediatric Lower Extremity Function(Mobility)", 24);
            call reorder_concept_set(@observation_form_name, "LLA, Lower Extremity Functional Index (LEFI)", 25);
            call reorder_concept_set(@observation_form_name, "LLA, Additional comments", 26);
            call reorder_concept_set(@observation_form_name, "LLA, Follow-up Plan", 27);
    </sql>
  </changeSet>

  <changeSet id="AMMAN_CONFIG_20230900774338866" author="Venky, Shyam">
    <comment>Adding CEIL codes to concepts</comment>
    <sql>
            SELECT concept_source_id INTO @source_id FROM concept_reference_source where name = "CEIL";

            call CREATE_REFERENCE_MAPPING_CEIL("Bone lengthening","166708");
            call CREATE_REFERENCE_MAPPING_CEIL("Peripheral nerve injury rehabilitation","130421");
            call CREATE_REFERENCE_MAPPING_CEIL("Tendon rehabilitation","166839");
            call CREATE_REFERENCE_MAPPING_CEIL("Amputation","164009");
    </sql>
  </changeSet>

</databaseChangeLog>
